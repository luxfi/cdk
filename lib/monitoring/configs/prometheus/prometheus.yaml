global:
  scrape_interval: 5s
  scrape_timeout: 5s
  evaluation_interval: 15s
  external_labels:
    container: ${HOSTNAME}
rule_files:
  - "/etc/prometheus-rules/*.rules"

scrape_configs:
  - job_name: "prometheus"
    metrics_path: "/metrics"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "kube-state-metrics"
    static_configs:
      - targets: ["kube-state-metrics.kube-system:8080"]

  - job_name: "kubernetes-service-endpoints"
    scrape_interval: 5s
    scrape_timeout: 2s
    kubernetes_sd_configs:
      - role: service
        namespaces:
          names:
            - monitoring
            - ava
    relabel_configs:
      - source_labels:
          [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      # - source_labels:
      #     [__meta_kubernetes_service_annotation_prometheus_io_scheme]
      #   action: replace
      #   target_label: __scheme__
      #   regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels:
          [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        separator: ;
        regex: ([^:]+)(?::\d+)?;(\d+)
        target_label: __address__
        replacement: $1:$2
        action: replace

      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
    # - source_labels: [__meta_kubernetes_namespace]
    #   separator: ;
    #   regex: (.*)
    #   target_label: namespace
    #   replacement: $1
    #   action: replace
    # - source_labels: [__meta_kubernetes_namespace]
    #   action: replace
    #   target_label: kubernetes_namespace
    # - source_labels: [__meta_kubernetes_service_name]
    #   action: replace
    #   target_label: kubernetes_name

  # - job_name: ava-exporter
  #   metrics_path: "/metrics"
  #   kubernetes_sd_configs:
  #     - role: pod
  #       follow_redirects: true
  #       namespaces:
  #         names:
  #           - monitoring
  #           - ava
  #           - default
  #   relabel_configs:
  #     - source_labels: [__meta_kubernetes_pod_annotation_avalance_scrape]
  #       action: keep
  #       regex: true
  #     - action: labelmap
  #       regex: __meta_kubernetes_pod_label_(.+)
  #     - source_labels: [__address__]
  #       target_label: __param_target
  #     - source_labels: [__param_target]
  #       target_label: instance
  #     - target_label: __address__
  #       source_labels: [__param_target]
  #       replacement: $1:9001
  # - source_labels: [__meta_kubernetes_service_label_app]
  #   separator: ;
  #   regex: (.*)
  #   replacement: $1
  #   action: keep
  # - source_labels: [__meta_kubernetes_endpoint_port_name]
  #   separator: ;
  #   regex: port
  #   replacement: $1
  #   action: keep
  # - source_labels: [__meta_kubernetes_namespace]
  #   separator: ;
  #   regex: (.*)
  #   target_label: namespace
  #   replacement: $1
  #   action: replace
  # - source_labels: [__meta_kubernetes_pod_name]
  #   separator: ;
  #   regex: (.*)
  #   target_label: pod
  #   replacement: $1
  #   action: replace
  # - source_labels: [__meta_kubernetes_service_name]
  #   separator: ;
  #   regex: (.*)
  #   target_label: service
  #   replacement: $1
  #   action: replace
  # - source_labels: [__meta_kubernetes_service_name]
  #   separator: ;
  #   regex: (.*)
  #   target_label: job
  #   replacement: ${1}
  #   action: replace
  # - separator: ;
  #   regex: (.*)
  #   target_label: endpoint
  #   replacement: $1
  #   action: replace

  # tls_config:
  #   ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  #   insecure_skip_verify: true
  # bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  # kubernetes_sd_configs:
  #   - role: service
  # relabel_configs:
  #   - action: labelmap
  #     regex: __meta_kubernetes_pod_label_(.+)
  #   - source_labels: [__meta_kubernetes_namespace]
  #     action: replace
  #     target_label: namespace
  #   - source_labels: [__meta_kubernetes_namespace]
  #     action: replace
  #     target_label: kubernetes_namespace

  # - job_name: "pods"
  #   kubernetes_sd_configs:
  #     - role: pod
  #   relabel_configs:
  #     - action: labelmap
  #       regex: __meta_kubernetes_pod_label_(.+)
  #     - source_labels: [__meta_kubernetes_namespace]
  #       action: replace
  #       target_label: namespace
  #     - source_labels: [__meta_kubernetes_pod_name]
  #       action: replace
  #       target_label: pod
