global:
  scrape_interval: 30s
  scrape_timeout: 30s
  evaluation_interval: 15s
rule_files:
  - "/etc/prometheus-rules/*.rules"

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets:
          [
            "prometheus.service.monitoring.svc.cluster.local:9090",
            "localhost:9090",
          ]
    relabel_configs:

  - job_name: "kube-state-metrics"
    static_configs:
      - targets: ["kube-state-metrics.kube-system:8080"]

  - job_name: "k8apiserver"
    kubernetes_sd_configs:
      - role: endpoints
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true # Required if using Minikube.
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - source_labels:
          [
            __meta_kubernetes_namespace,
            __meta_kubernetes_service_name,
            __meta_kubernetes_endpoint_port_name,
          ]
        action: keep
        regex: default;kubernetes;https

  - job_name: "k8pods"
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_container_port_name]
        regex: metrics
        action: keep
      - source_labels: [__meta_kubernetes_pod_container_name]
        target_label: job

  - job_name: ava-exporter
    metrics_path: "/metrics"
    scheme: http
    static_configs:
      - targets: ["ava-exporter.monitoring.svc.cluster.local:9001"]
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # kubernetes_sd_configs:
    #   - role: service
    # relabel_configs:
    #   - action: labelmap
    #     regex: __meta_kubernetes_pod_label_(.+)
    #   - source_labels: [__meta_kubernetes_namespace]
    #     action: replace
    #     target_label: namespace
    #   - source_labels: [__meta_kubernetes_namespace]
    #     action: replace
    #     target_label: kubernetes_namespace

  # - job_name: "pods"
  #   kubernetes_sd_configs:
  #     - role: pod
  #   relabel_configs:
  #     - action: labelmap
  #       regex: __meta_kubernetes_pod_label_(.+)
  #     - source_labels: [__meta_kubernetes_namespace]
  #       action: replace
  #       target_label: namespace
  #     - source_labels: [__meta_kubernetes_pod_name]
  #       action: replace
  #       target_label: pod
